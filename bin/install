#!/usr/bin/env bash

set -e
set -o pipefail

ASDF_INSTALL_TYPE=${ASDF_INSTALL_TYPE:-version  }
TMPDIR=${TMPDIR:-/tmp}
[ -n "$ASDF_INSTALL_VERSION" ] || (>&2 echo 'Missing ASDF_INSTALL_VERSION' && exit 1)
[ -n "$ASDF_INSTALL_PATH" ] || (>&2 echo 'Missing ASDF_INSTALL_PATH' && exit 1)

install_vector() {
	local install_type=$1
	local version=$2
	local install_path=$3
	local platform="$(get_arch)"
	local bin_install_path="$install_path/bin"
	local download_url="$(get_download_url $version)"

	mkdir -p "${bin_install_path}"

	echo "Downloading vector from ${download_url}"
	curl -L "$download_url" | tar -xzf - --directory ${bin_install_path} --strip-components 3 ./vector-x86_64-${platform}/bin/vector
	chmod +x ${bin_install_path}/vector
}

get_arch() {
	if [[ $(uname -s) == "Darwin" ]]; then
		echo "apple-$(uname | tr '[:upper:]' '[:lower:]')"
	elif [[ $(uname -s) == "Linux" ]]; then
		echo "unknown-$(uname | tr '[:upper:]' '[:lower:]')-gnu"
	else
		>&2 echo 'Platform not supported' && exit 1
	fi
}

get_download_url() {
	local version="$1"
	local platform="$(get_arch)"
	echo "https://github.com/timberio/vector/releases/download/v${version}/vector-${version}-x86_64-${platform}.tar.gz"
}

install_vector $ASDF_INSTALL_TYPE $ASDF_INSTALL_VERSION $ASDF_INSTALL_PATH
